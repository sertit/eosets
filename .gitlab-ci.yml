stages:
  - lint
  - test
  - weekly_tests
  - publish
  - docs

variables:
  EEO_DEPS: $REGISTRY_GITLAB/extracteo/extracteo_deps
  EO_CONTAINER: $REGISTRY_GITLAB/eo-containers/python

lint:
  image: python:3.8-buster
  stage: lint
  script:
    - python -m pip install --upgrade pip
    - pip install flake8
    - flake8 eopairs
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: always


upload_wheel:linux:
  image: python:3.9-buster
  stage: publish
  script:
    - pip install twine
    - python setup.py sdist bdist_wheel
    - TWINE_PASSWORD=${GITLAB_RW_TOKEN_PWD} TWINE_USERNAME=${GITLAB_RW_TOKEN_NAME} python -m twine upload --config-file ./.pypirc -r gitlab dist/*
  tags:
    - sertit
    - linux
  only:
    - tags

pages:
  image: $EO_CONTAINER:3.9
  stage: docs
  script:
    - python -m pip install --upgrade pip
    - pip install -r requirements-docs.txt
    - sphinx-build docs docs/_build/html
    - mv docs/_build/html public/
  artifacts:
    paths:
      - public
  tags:
    - sertit
    - linux
